# Chapter 22. 이벤트 시간과 상태 기반 처리

## 들어가기 전에

- 이벤트 시간 처리: 이벤트 생성 시간 / 이벤트 처리 시간

### 22.1 이벤트 시간 처리

- 이벤트를 "처리 시간" 기반으로 데이터 분석하면, 데이터를 보내는 물리적 위치에 따라 이벤트 생성 시간이 더 빠르더라도 처리 시간이 늦어질 수 있음.

  - 예: 버지니아에서 보낸 데이터 vs 에콰도르에서 보낸 데이터

- 즉, 결과 값이 반드시 이벤트 발생 시간 순으로 정렬되었다고 할 수 없음.


### 22.2 상태 기반 처리

- 스파크에서는 구조적 스트리밍이 사용자를 대신해서 정보를 유지하고 갱신함.

- 사용자는 단순하게 로직만 정의하고, 중간 상태 정보를 상태 저장소에 저장함.

### 22.3 임의적인 상태 기반 처리

- 상태 유형, 갱신 방법, 제거 시점에 따라 세밀한 제어 가능함.

- 예: 에러 횟수에 따른 알람이나 리포팅, 중복 이벤트 제거 작업 등.

### 22.4 이벤트 시간 처리의 기본

- 이벤트 시간에 대한 정의를 무엇으로 둘 것이냐?

  - 이벤트 생성시간인가?

  - 서버에 도착한 시간인가?

### 22.5 이벤트 시간 윈도우

- 타임스탬프 컬럼을 적절한 스파크 SQL 타임스탬프 데이터 타입으로 변환하는 것이 시작.

#### 22.5.1 텀블링 윈도우

- 주어진 슬라이딩 윈도우에서 이벤트 발생 횟수 카운트

##### 슬라이딩 윈도우

- 윈도우를 윈도우 시작 시각에서 분리해서 실행하는 방법.

- 지난 시간에서 데이터 유지하면서 연속적으로 값 갱신.

#### 22.5.2 워터마크로 지연 데이터 제어하기

- 얼마나 늦게까지 들어온 데이터를 받을 것인가?

- 워터마크 또는 데이터가 필요 없어지는 시간에 대한 기록이 지정되지 않았음.

- 워터마크는 특정 시간 이후 처리에서 제외할 이벤트나 이벤트 집합에 대한 시간 기준임.

- DStream API에서는 이 기준이 명확하게 없는데, 구조적 스트리밍에는 있음.

- 이벤트 시간과 상태 기반 처리를 사용하면 특정 윈도우의 상태나 데이터셋의 처리 윈도우에서 분리됨.

- 예를 들어, 워터마크를 10분 지정하면 10분 전에 일어난 모든 이벤트 무시함.

### 22.6 스트림에서 중복 데이터 제거하기

- 중복을 처리한다 -> 레코드 단위 처리 시스템에서 여러 레코드를 반드시 한 번은 처리한다는 뜻임.

- 높은 부하 발생함. 키를 기준으로 중복 제거해서 최소 한 번 (at-least-once) 처리하는 방식을 제공하는 메세지 시스템을 쉽게 사용함.

### 22.7 임의적인 상태 기반 처리

- 복잡한 윈도우 처리 방식이 필요한 경우

- 윈도우와 워터마크를 함께 사용해서 윈도우 시작 시각이 워터마크보다 작아질 때 윈도우 제거도 가능함.

#### 22.7.1 타임아웃

- 중간 상태를 제거하기 전 기다려야하는 시간 정의

- 타임 아웃을 지정하더라도 워터 마크는 별도 설정 꼭 필요.

- 워터 마크가 타임스탬프를 초과해야 타임 아웃이 발생하기 때문.

#### 22.7.2 출력모드

- 타임아웃 이후 결과 셋에 대해 데이터를 볼 때 사용

- 사용자 정의 상태 기반 처리는 출력 모드 지원을 안하기 때문에 mapGroupsWithState나 flatMapGroupsWithState 등 사용해서 출력 값 확인가능

#### 22.7.3 mapGroupsWithState

- 갱신된 데이터셋을 입력으로 받고 값을 특정 키로 분배하는 사용자 정의 집계 함수와 매우 흡사.

#### 22.7.4 flatMapGroupsWithState

- 단일 키가 여러 출력 결과를 만드는 것을 제외하고 구조는 mapGroupsWithState와 매우 유사.